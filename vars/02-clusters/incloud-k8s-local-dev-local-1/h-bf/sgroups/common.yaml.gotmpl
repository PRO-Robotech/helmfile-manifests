{{- $mainDomain := printf "%s.%s.%s" .Release.Name .Release.Namespace .Values.global.domains.internal -}}

helm-inserter:
  templates:
    SGWebVS: |
      ---
      apiVersion: networking.istio.io/v1alpha3
      kind: VirtualService
      metadata:
        name: {{ $.Release.Name }}-web-vs
        namespace: {{ $.Release.Namespace }}
      spec:
        hosts:
          - {{ .Release.Name }}
          - {{ .Release.Name }}.{{ .Release.Namespace }}
          - {{ .Release.Name }}.{{ .Release.Namespace }}.svc
          - {{ $mainDomain }}
        gateways:
          - incloud-istio/istio-ingressgateway
        http:
          - name: web
            match:
              - uri:
                  prefix: /client
            rewrite:
              uri: /client
            route:
              - destination:
                  host: {{ $.Release.Name }}-web
                  port:
                    number: 80

          - name: istio-ingress-redirect
            match:
              - uri:
                  prefix: /
            redirect:
              uri: /client
              authority: {{ $mainDomain }}

    SGServerVS: |
      ---
      apiVersion: networking.istio.io/v1alpha3
      kind: VirtualService
      metadata:
        name: {{ $.Release.Name }}-server-vs
        namespace: {{ $.Release.Namespace }}
      spec:
        hosts:
          - {{ .Release.Name }}
          - {{ .Release.Name }}.{{ .Release.Namespace }}
          - {{ .Release.Name }}.{{ .Release.Namespace }}.svc
          - {{ $mainDomain }}
        gateways:
          - incloud-istio/istio-ingressgateway
        http:
          - name: server
            match:
              - uri:
                  prefix: /server/
            rewrite:
              uri: /
            route:
              - destination:
                  host: {{ $.Release.Name }}-server
                  port:
                    number: 9006
